# %%

from typing import Any

from lib.evagg.ref import NcbiLookupClient
from lib.evagg.svc import CosmosCachingWebClient, RequestsWebContentClient, get_dotenv_settings

client = NcbiLookupClient(
    # CosmosCachingWebClient(get_dotenv_settings(filter_prefix="EVAGG_CONTENT_CACHE_")),
    RequestsWebContentClient(),
    settings=get_dotenv_settings(filter_prefix="NCBI_EUTILS_"),
)


# %%


def id_from_xml(root: Any) -> str:
    # Check the count for the search result
    count = int(root.find(".//Count").text)
    if count != 1:
        raise ValueError(f"Expected 1 result, got {count}")
    return root.find(".//Id").text


def gene_id_for_ensg(ensg: str) -> str:
    result = client._esearch(db="gene", term=ensg, sort="none")
    return id_from_xml(result)


def gene_symbol_for_id(gene_id: str) -> str:
    # Poor implementation. Very large data payload
    result = client._efetch(db="gene", id=gene_id, retmode="text", rettype="gene_table")
    return result.split(" ", maxsplit=1)[0]


# %%
# ensgs = [
#     "ENSG00000198763",
#     "ENSG00000163697",
#     "ENSG00000171843",
#     "ENSG00000107611",
#     "ENSG00000161609",
#     "ENSG00000186867",
# ]

if not ensgs:
    print("Run one of the cells below.")

# %%
import time

pairings = {}
for ensg in list(set(ensgs)):
    print("processing ", ensg)

    try:
        gene_id = gene_id_for_ensg(ensg)
    except Exception as e:
        print(f"gene_id_for_ensg: Error for {ensg}: {e}")
        continue

    try:
        gene_symbol = gene_symbol_for_id(gene_id)
    except Exception as e:
        print(f"gene_symbol_for_id: Error for {ensg}: {e}")
        continue

    time.sleep(0.5)
    
    pairings[ensg] = (gene_symbol, gene_id)


# %% Dominant restrictive search
ensgs = [
    "ENSG00000107611",
    "ENSG00000119915",
    "ENSG00000030066",
    "ENSG00000198938",
    "ENSG00000109320",
    "ENSG00000141252",
    "ENSG00000123815",
    "ENSG00000204983",
    "ENSG00000198763",
    "ENSG00000198886",
    "ENSG00000169641",
    "ENSG00000171843",
    "ENSG00000163697",
    "ENSG00000148357",
    "ENSG00000137802",
    "ENSG00000140563",
    "ENSG00000257103",
    "ENSG00000196440",
    "ENSG00000227191",
    "ENSG00000011485",
    "ENSG00000132821",
    "ENSG00000186867",
    "ENSG00000135299",
    "ENSG00000204983",
    "ENSG00000174106",
    "ENSG00000175265",
    "ENSG00000102225",
    "ENSG00000161609",
    "ENSG00000099994",
]

# %% Dominant permissive search
ensgs = [
    "ENSG00000205116",
    "ENSG00000142609",
    "ENSG00000215912",
    "ENSG00000078900",
    "ENSG00000142599",
    "ENSG00000243073",
    "ENSG00000142621",
    "ENSG00000142621",
    "ENSG00000185519",
    "ENSG00000127481",
    "ENSG00000142798",
    "ENSG00000142798",
    "ENSG00000142798",
    "ENSG00000169641",
    "ENSG00000134644",
    "ENSG00000121775",
    "ENSG00000084070",
    "ENSG00000132781",
    "ENSG00000142700",
    "ENSG00000162599",
    "ENSG00000172339",
    "ENSG00000118733",
    "ENSG00000116266",
    "ENSG00000173947",
    "ENSG00000178104",
    "ENSG00000159208",
    "ENSG00000159450",
    "ENSG00000143631",
    "ENSG00000143631",
    "ENSG00000143631",
    "ENSG00000143631",
    "ENSG00000143631",
    "ENSG00000143183",
    "ENSG00000075391",
    "ENSG00000135842",
    "ENSG00000135842",
    "ENSG00000118194",
    "ENSG00000143816",
    "ENSG00000198626",
    "ENSG00000228198",
    "ENSG00000228198",
    "ENSG00000228198",
    "ENSG00000115705",
    "ENSG00000198399",
    "ENSG00000119787",
    "ENSG00000183023",
    "ENSG00000143919",
    "ENSG00000068878",
    "ENSG00000170485",
    "ENSG00000115947",
    "ENSG00000153250",
    "ENSG00000172292",
    "ENSG00000144451",
    "ENSG00000079308",
    "ENSG00000079308",
    "ENSG00000135924",
    "ENSG00000123983",
    "ENSG00000157985",
    "ENSG00000176720",
    "ENSG00000131389",
    "ENSG00000131381",
    "ENSG00000235493",
    "ENSG00000189283",
    "ENSG00000163618",
    "ENSG00000172969",
    "ENSG00000144802",
    "ENSG00000206531",
    "ENSG00000159685",
    "ENSG00000196353",
    "ENSG00000091513",
    "ENSG00000136521",
    "ENSG00000113916",
    "ENSG00000113916",
    "ENSG00000145012",
    "ENSG00000145012",
    "ENSG00000145113",
    "ENSG00000145113",
    "ENSG00000145113",
    "ENSG00000145113",
    "ENSG00000145113",
    "ENSG00000145113",
    "ENSG00000184985",
    "ENSG00000163697",
    "ENSG00000182308",
    "ENSG00000198515",
    "ENSG00000138759",
    "ENSG00000248713",
    "ENSG00000109320",
    "ENSG00000186867",
    "ENSG00000164142",
    "ENSG00000173320",
    "ENSG00000173320",
    "ENSG00000260596",
    "ENSG00000260596",
    "ENSG00000145506",
    "ENSG00000145495",
    "ENSG00000249156",
    "ENSG00000249156",
    "ENSG00000164256",
    "ENSG00000164256",
    "ENSG00000164256",
    "ENSG00000113384",
    "ENSG00000185305",
    "ENSG00000123213",
    "ENSG00000153347",
    "ENSG00000177879",
    "ENSG00000038532",
    "ENSG00000261934",
    "ENSG00000261934",
    "ENSG00000261934",
    "ENSG00000145919",
    "ENSG00000158169",
    "ENSG00000206503",
    "ENSG00000206503",
    "ENSG00000206503",
    "ENSG00000206503",
    "ENSG00000204385",
    "ENSG00000204296",
    "ENSG00000237541",
    "ENSG00000197283",
    "ENSG00000137251",
    "ENSG00000135299",
    "ENSG00000010810",
    "ENSG00000131016",
    "ENSG00000131016",
    "ENSG00000131018",
    "ENSG00000091844",
    "ENSG00000106268",
    "ENSG00000106266",
    "ENSG00000164916",
    "ENSG00000070882",
    "ENSG00000106086",
    "ENSG00000227191",
    "ENSG00000183166",
    "ENSG00000196367",
    "ENSG00000169894",
    "ENSG00000169894",
    "ENSG00000169894",
    "ENSG00000169894",
    "ENSG00000169894",
    "ENSG00000169894",
    "ENSG00000169894",
    "ENSG00000169894",
    "ENSG00000169894",
    "ENSG00000169894",
    "ENSG00000205277",
    "ENSG00000205277",
    "ENSG00000205277",
    "ENSG00000169876",
    "ENSG00000285437",
    "ENSG00000128596",
    "ENSG00000182158",
    "ENSG00000204983",
    "ENSG00000204983",
    "ENSG00000204983",
    "ENSG00000130226",
    "ENSG00000055118",
    "ENSG00000009335",
    "ENSG00000009335",
    "ENSG00000146918",
    "ENSG00000172748",
    "ENSG00000173273",
    "ENSG00000104635",
    "ENSG00000147548",
    "ENSG00000155099",
    "ENSG00000070756",
    "ENSG00000205002",
    "ENSG00000153310",
    "ENSG00000042832",
    "ENSG00000131773",
    "ENSG00000147724",
    "ENSG00000169398",
    "ENSG00000180155",
    "ENSG00000181638",
    "ENSG00000181638",
    "ENSG00000153707",
    "ENSG00000171843",
    "ENSG00000147889",
    "ENSG00000198853",
    "ENSG00000107338",
    "ENSG00000240240",
    "ENSG00000184659",
    "ENSG00000184659",
    "ENSG00000154330",
    "ENSG00000165152",
    "ENSG00000165152",
    "ENSG00000136935",
    "ENSG00000188483",
    "ENSG00000148357",
    "ENSG00000125492",
    "ENSG00000165695",
    "ENSG00000181090",
    "ENSG00000151474",
    "ENSG00000107611",
    "ENSG00000055950",
    "ENSG00000119915",
    "ENSG00000148841",
    "ENSG00000203867",
    "ENSG00000089876",
    "ENSG00000089876",
    "ENSG00000089876",
    "ENSG00000175470",
    "ENSG00000175470",
    "ENSG00000175470",
    "ENSG00000171813",
    "ENSG00000274897",
    "ENSG00000184956",
    "ENSG00000184956",
    "ENSG00000184956",
    "ENSG00000184956",
    "ENSG00000117983",
    "ENSG00000117983",
    "ENSG00000117983",
    "ENSG00000117983",
    "ENSG00000078902",
    "ENSG00000174672",
    "ENSG00000205869",
    "ENSG00000167323",
    "ENSG00000167323",
    "ENSG00000167323",
    "ENSG00000167323",
    "ENSG00000167325",
    "ENSG00000051009",
    "ENSG00000166311",
    "ENSG00000110693",
    "ENSG00000109851",
    "ENSG00000030066",
    "ENSG00000124942",
    "ENSG00000124942",
    "ENSG00000124942",
    "ENSG00000110075",
    "ENSG00000132749",
    "ENSG00000132749",
    "ENSG00000132749",
    "ENSG00000110172",
    "ENSG00000165325",
    "ENSG00000255501",
    "ENSG00000255501",
    "ENSG00000149308",
    "ENSG00000182985",
    "ENSG00000110274",
    "ENSG00000182667",
    "ENSG00000182667",
    "ENSG00000013573",
    "ENSG00000151233",
    "ENSG00000151233",
    "ENSG00000151233",
    "ENSG00000211584",
    "ENSG00000135424",
    "ENSG00000196531",
    "ENSG00000139266",
    "ENSG00000139266",
    "ENSG00000061987",
    "ENSG00000174106",
    "ENSG00000111452",
    "ENSG00000090612",
    "ENSG00000102780",
    "ENSG00000183098",
    "ENSG00000134884",
    "ENSG00000187498",
    "ENSG00000205978",
    "ENSG00000151322",
    "ENSG00000179841",
    "ENSG00000205659",
    "ENSG00000119638",
    "ENSG00000119638",
    "ENSG00000177108",
    "ENSG00000185567",
    "ENSG00000185567",
    "ENSG00000166206",
    "ENSG00000249931",
    "ENSG00000175265",
    "ENSG00000175265",
    "ENSG00000175265",
    "ENSG00000137815",
    "ENSG00000062524",
    "ENSG00000137802",
    "ENSG00000067369",
    "ENSG00000166147",
    "ENSG00000129003",
    "ENSG00000128973",
    "ENSG00000173546",
    "ENSG00000103740",
    "ENSG00000041357",
    "ENSG00000273540",
    "ENSG00000183208",
    "ENSG00000140563",
    "ENSG00000140470",
    "ENSG00000213918",
    "ENSG00000162104",
    "ENSG00000156968",
    "ENSG00000214940",
    "ENSG00000169180",
    "ENSG00000233232",
    "ENSG00000140718",
    "ENSG00000087253",
    "ENSG00000087253",
    "ENSG00000104731",
    "ENSG00000170100",
    "ENSG00000170100",
    "ENSG00000170100",
    "ENSG00000167522",
    "ENSG00000141252",
    "ENSG00000108523",
    "ENSG00000259024",
    "ENSG00000170315",
    "ENSG00000108557",
    "ENSG00000091536",
    "ENSG00000177731",
    "ENSG00000184185",
    "ENSG00000184185",
    "ENSG00000184185",
    "ENSG00000184185",
    "ENSG00000184185",
    "ENSG00000198720",
    "ENSG00000204880",
    "ENSG00000196156",
    "ENSG00000161692",
    "ENSG00000136436",
    "ENSG00000108813",
    "ENSG00000176809",
    "ENSG00000176809",
    "ENSG00000182481",
    "ENSG00000069188",
    "ENSG00000185262",
    "ENSG00000169710",
    "ENSG00000170579",
    "ENSG00000267761",
    "ENSG00000071991",
    "ENSG00000071991",
    "ENSG00000060069",
    "ENSG00000104897",
    "ENSG00000176533",
    "ENSG00000141873",
    "ENSG00000141873",
    "ENSG00000141873",
    "ENSG00000167676",
    "ENSG00000167676",
    "ENSG00000174837",
    "ENSG00000181143",
    "ENSG00000171469",
    "ENSG00000105397",
    "ENSG00000141837",
    "ENSG00000130311",
    "ENSG00000130300",
    "ENSG00000213973",
    "ENSG00000257103",
    "ENSG00000089351",
    "ENSG00000089351",
    "ENSG00000105738",
    "ENSG00000123815",
    "ENSG00000242221",
    "ENSG00000242221",
    "ENSG00000283632",
    "ENSG00000104884",
    "ENSG00000011485",
    "ENSG00000105464",
    "ENSG00000161609",
    "ENSG00000198482",
    "ENSG00000130844",
    "ENSG00000204577",
    "ENSG00000204577",
    "ENSG00000167615",
    "ENSG00000196476",
    "ENSG00000025293",
    "ENSG00000132821",
    "ENSG00000101134",
    "ENSG00000160194",
    "ENSG00000197381",
    "ENSG00000173638",
    "ENSG00000160299",
    "ENSG00000099994",
    "ENSG00000100029",
    "ENSG00000249310",
    "ENSG00000198223",
    "ENSG00000198223",
    "ENSG00000185291",
    "ENSG00000185291",
    "ENSG00000101871",
    "ENSG00000188158",
    "ENSG00000198173",
    "ENSG00000250349",
    "ENSG00000156298",
    "ENSG00000102225",
    "ENSG00000158352",
    "ENSG00000204131",
    "ENSG00000196440",
    "ENSG00000166681",
    "ENSG00000166681",
    "ENSG00000133138",
    "ENSG00000133138",
    "ENSG00000175718",
    "ENSG00000236446",
    "ENSG00000156500",
    "ENSG00000147274",
    "ENSG00000198763",
    "ENSG00000198804",
    "ENSG00000198938",
    "ENSG00000198886",
    "ENSG00000198727",
]

# %%
